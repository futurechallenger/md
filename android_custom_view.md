# 创建Android自定义视图
任何的开发都不应该是简单地界面视图的堆砌，即使是堆砌也应该是有序的、可复用的。下面我们来讲解如何实现一个自定义视图。

## 继承一个View
Android里定义的所有视图类都是继承自`View`的。你的自定义视图也可以直接继承`View`，但是这样的话就需要自己实现很多已经在Android SDK里实现好的代码。时间很宝贵，所以还是在别人实现好的基础上来实现我们需要的部分是最合适的，比如我们要改造一个按钮就直接继承`Button`好了。不过作为讲解我们继承`View`来实现一个简单的饼图。
```kotlin
class PieChart : View {
  private var _context: Context ? = null

  constructor(context: Context) : super(context) {

  }

  constructor(context: Context, attrs: AttributeSet) : super(context, attrs) {
    this._context = context 
  }

  constructor(context: Context, attrs: AttributeSet, defStyleAttr: Int) : super(context, attrs, defStyleAttr) {

  }
}
```
这只是一个简单的例子。我们要定义一个`PieChart`的视图，它继承了`View`。里面给出了三个构造函数。

## 添加自定义属性
要在界面中添加一个内置的视图，你只需要在XML的布局中定义出对应的界面和行为等属性。一个良好的自定义的视图也是可以在XML中定义并添加样式。要实现这个效果，你需要:
1. 在`<declare-styleable>`中添加自定义视图的属性。
2. 在XML布局文件中定义这些属性的值。
3. 在运行时获取属性值。
4. 在自定义视图中使用这些属性。

添加一个资源文件来存放自定义视图的属性。路径为：*res/values/attrs.xml*。attrs.xml文件是这样的：
```xml
<resources>
    <declare-styleable name="PieChart">
        <attr name="showText" format="boolean" />
        <attr name="labelPosition" format="enum">
            <enum name="left" value="0" />
            <enum name="right" value="1" />
        </attr>
    </declare-styleable>
</resources>
```
上面的代码定义了两个自定义属性：`showText`和`labelPosition`。并且这两个属性都属于名称为`PicChart`的节点下。一般这个节点的名称就是你的自定义视图的名称，当然你也可以不这么干。

下面看看定义好的属性该如何使用。
```xml
<LinearLayout
    xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    tools:context="test.demo.myapplication.customViews.CustoViewmActivity">

    <test.demo.myapplication.customViews.PieChart
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        app:labelPosition="left"
        app:showText="true"/>

</LinearLayout>
```
在XML布局中直接使用一个自定义View就是这样的`test.demo.myapplication.customViews.PieChart`。如果在`PieChart`里有一个内部类`PieView`要使用的话，那么就是这样的：`test.demo.myapplication.customViews.PieChart$PieView`。用**$**分割。

## 使用自定义属性
前文我们在XML布局文件里使用的属性都会从资源文件的bundle里读取出来，并作为一个`AttributeSet`实例传入View的构造函数里。

虽然可以直接读取`AttributeSet`的数据，但是不推荐这样。一般都是把`AttributeSet`传入`obtainStyledAttributes()`方法里，并使用这个方法的返回值`TypedArray`。如：
```kotlin
  constructor(context: Context, attrs: AttributeSet) : super(context, attrs) {
    this._context = context
    var a = context.theme.obtainStyledAttributes(attrs, R.styleable.PieChart, 0, 0)
    try {
      _showText = a.getBoolean(R.styleable.PieChart_showText, false) as Boolean
    } finally {
      a.recycle()
    }
  }
```
**注意：**`TypedArray`是共享的资源，使用之后必须回收。

## 添加属性和事件
属性是控制视图行为和围观的一个很有效的途径，但是视图初始化之后就只能读取了。要提供动态行为，就暴露属性的一个getter和一个setter。下面的代码里展示了`PieChart`是如何暴露`showText`属性的：
```kotlin
  fun isShowText():Boolean {
    return _showText
  }
  
  fun setShowText(showText:Boolean) {
    _showText = showText
    invalidate()
    requestLayout()
  }
```
注意`setShowText`调用了`invalidate()`和`requestLayout()`两个方法。这些调用才是视图动态行为的保证。改变了视图的属性之后，你必须invalidate了视图才能改变它的外观。这几个方法用来通知系统视图需要重绘。同样的，属性的更改如果影响到视图的外观，比如大小或者形状，你也需要请求一个新的布局。这些方法如果不调用的话会出现很难找到的bug。

自定义视图也支持添加事件。比如`PieChart`暴露一个自定义的事件`OnCurrentItemChanged`。这个事件可以用来通知监听器用户改变了当前的关注的图块。看下代码是什么样的：
```kotlin
class PieChart : View {
  public interface OnCurrentItemChangedListener {
    fun OnCurrentItemChanged(source: PieChart, currentItem: Int)
  }

  fun setCurrentItem(currentItem: Int, scrollIntoView: Boolean) {
    _currentItem = currentItem
    if (_currentItemChangedListener != null) {
      _currentItemChangedListener!!.OnCurrentItemChanged(this, currentItem)
    }
    if (scrollIntoView) {
      centerOnCurrentItem()
    }
    invalidate()
  }

  fun setCurrentItemChangedListener(listener: OnCurrentItemChangedListener) {
    _currentItemChangedListener = listener
  }
}
```
首先自定义一个接口`OnCurrentItemChangedListener`为以后使用。在方法`setCurrentItemChangedListener`中设置listener。并在事件发生的时候调用listener，通知监听器。

这样一个自定义的视图就完成了。










































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































